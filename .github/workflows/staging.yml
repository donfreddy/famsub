name: Build and Push Docker Images

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering from GitHub UI

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.changes.outputs.api }}
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: 📂 Check for changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          base: 'main'
          filters: |
            api:
            - 'apps/api/**'
            - 'packages/**'
            - '.github/workflows/staging.yml'

  build-and-push-api-image:
    name: 🐳 Build & Push API Docker image
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v5

      - name: 🔄 Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: 🔑 Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: 🐳 Build and push Docker image
        env:
          IMAGE_NAME: ghcr.io/donfreddy/famsub-api
          COMMIT_SHA: ${{ github.sha }}
        run: |
          # Get short SHA
          SHORT_SHA=$(echo "$COMMIT_SHA" | cut -c1-7)
          echo "Building and pushing image: $IMAGE_NAME:$SHORT_SHA and $IMAGE_NAME:latest"
          
          # Build and push image
          docker buildx build \
            --platform linux/amd64 \
            -f ./apps/api/Dockerfile \
            -t $IMAGE_NAME:$SHORT_SHA \
            -t $IMAGE_NAME:latest . \
            --push

      - name: 📬 Notify Portainer of new image
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{"status": "success", "message": "Image successfully built and pushed"}' \
            https://portainer.famsub.com/api/webhooks/5d4931df-82ff-4b34-b2e9-9fbd1fed1090